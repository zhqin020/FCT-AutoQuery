# Coverage Report — 2025-11-27

Summary of test run and coverage for `FCT-AutoQuery`.


Command run:

```
PYTHONPATH=. pytest --cov=src --cov-report=term --cov-report=html:coverage_html --cov-report=xml:coverage.xml -q
```


Results:

- Tests: 72 passed, 1 skipped
- Coverage summary (selected files):

```
Name                                    Stmts   Miss  Cover
-----------------------------------------------------------
src/cli/main.py                           329    163    50%
src/cli/purge.py                          177     48    73%
src/lib/config.py                         162     49    70%
src/models/case.py                         41      4    90%
src/services/batch_service.py              41      1    98%
src/services/case_scraper_service.py     1092    747    32%
TOTAL                                    2606   1242    52%
```

Artifacts produced:

- HTML coverage report: `coverage_html/` (updated)
- XML coverage report: `coverage.xml` (updated)

Run details:

- Command: `pytest --cov=src --cov-report=term --cov-report=html:coverage_html --cov-report=xml:coverage.xml -q`
- Duration: ~5.3s

Generated on: 2025-11-27

Artifacts produced:

- HTML coverage report: `coverage_html/`
- XML coverage report: `coverage.xml`

Notes:

- The `case_scraper_service.py` module remains the largest untested area (30% coverage). Consider adding focused unit tests for parsing helpers and isolating DOM-dependent code behind small adapters or the existing `FakeWebElement` test harness.
- The `coverage_html/` directory contains per-file breakdowns and can be opened in a browser for interactive inspection.

Next steps (suggested):

- Add unit tests for parsing functions in `src/services/case_scraper_service.py` (e.g., `_parse_label_value_table`, `_parse_date_str`).
- Consider marking `tests/` as a package or keep using `PYTHONPATH=.` when running tests in CI.

Generated on: 2025-11-27
# 测试覆盖率报告 — 2025-11-27

概览
------

命令：

```
python -m pytest --maxfail=1 -q --cov=src --cov-report=term --cov-report=html:coverage_html --cov-report=xml:coverage.xml
```

摘要（来自 pytest-cov 输出）：

- 测试通过：58 passed, 1 skipped
- 覆盖率总计：47%
- HTML 报告：`coverage_html/index.html`
- XML 报告：`coverage.xml`

按文件的覆盖率摘要（只列出核心文件）：

- `src/cli/main.py`: 50% (329 stmts, 163 miss)
- `src/cli/purge.py`: 73% (177 stmts, 48 miss)
- `src/lib/config.py`: 70% (162 stmts, 49 miss)
- `src/lib/rate_limiter.py`: 69% (42 stmts, 13 miss)
- `src/services/batch_service.py`: 98% (41 stmts, 1 miss) ✅
- `src/services/case_scraper_service.py`: 19% (1082 stmts, 874 miss) ⚠️（最大体量、覆盖率最低）
- `src/services/export_service.py`: 65% (292 stmts, 101 miss)
- `src/services/purge_service.py`: 64% (177 stmts, 64 miss)
- `src/services/url_discovery_service.py`: 68% (77 stmts, 25 miss)

主要发现与建议
-----------------

1. 总体覆盖率为 47%，低于常见的目标（例如 80%）。

2. 优先關注 `src/services/case_scraper_service.py`：
   - 体量最大（1082 行），覆盖率仅 19%，是拉低总覆盖率的主要因素。
   - 该模块与浏览器/网络交互密切相关，建议采用以下策略：
     - 抽取纯逻辑函数（解析、清理、数据建模）并为这些函数编写单元测试。
     - 将外部依赖（WebDriver、网络请求）封装并在测试中使用 mock/fixture 替换。
     - 添加快速的集成测试模式（例如 headless + 录制的响应/本地HTML fixture）来覆盖核心流程。

3. 其他中等优先级文件：`cli/main.py`, `export_service.py`, `purge_service.py`。
   - `cli/main.py` 可用集成测试（目前已添加 probe 的集成测试），但仍有路径未覆盖（交互、错误分支、audit 导出）。
   - `export_service.py` 的 DB/文件系统交互应用 mocks 覆盖，或在测试目录使用临时目录与测试数据库。

4. 建议的具体行动项（短期 -> 中期）：
   - 短期（1-2 天）
     - 为 `case_scraper_service` 抽取并单测解析/转换函数。
     - 为 `export_service` 添加 fs/db mock 测试（使用 tmp_path, sqlite memory）。
   - 中期（1-2 周）
     - 使用录制/回放或 fixture HTML 文件补充对 `case_scraper_service` 的集成测试。
     - 在 CI 中加入覆盖率检查（最低阈值，例如 40% -> 逐步提高到 80%）。

5. 如何复现覆盖率报告

在已激活的开发环境（`fct`）中运行：

```bash
# 安装（如尚未安装）
conda install -c conda-forge pytest-cov || pip install pytest-cov

# 生成覆盖率（终端摘要 + HTML + XML）
python -m pytest --maxfail=1 -q --cov=src --cov-report=term --cov-report=html:coverage_html --cov-report=xml:coverage.xml
```

后续
-----

如果你希望，我可以：

- 针对 `case_scraper_service.py` 起草一个逐步的测试计划并开始抽取可测试单元；
- 在 CI 中配置覆盖率阈值和 badge；
- 提交一个小 PR（例如：为 `export_service` 添加 tmp_path 单元测试）以示范测试模式。

报告生成：已保存为 `docs/coverage/report_20251127.md`。
