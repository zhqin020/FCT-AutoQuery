name: Purge Postgres Integration Test

on:
  push:
    branches: [ main, master, '0003-yearly-data-purge' ]
  pull_request:
    branches: [ main, master ]

jobs:
  postgres-test:
    name: Postgres SQL-year-filter test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres" --health-interval=5s --health-timeout=5s --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
          pip install psycopg2-binary

      - name: Wait for Postgres
        env:
          PGPASSWORD: postgres
        run: |
          python - <<'PY'
import time
import psycopg2
dsn = 'postgresql://postgres:postgres@localhost:5432/postgres'
for i in range(30):
    try:
        conn = psycopg2.connect(dsn)
        conn.close()
        print('Postgres is available')
        break
    except Exception as e:
        print('Waiting for Postgres...', e)
        time.sleep(1)
else:
    print('Postgres did not become available')
    raise SystemExit(1)
PY

      - name: Run Postgres purge test
        env:
          POSTGRES_TEST_DSN: postgresql://postgres:postgres@localhost:5432/postgres
        run: |
          pytest -q tests/services/test_purge_postgres_sql_filter.py -q
